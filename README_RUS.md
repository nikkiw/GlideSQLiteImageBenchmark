# Тестирование производительности Glide: SQLite BLOB против файловой системы

<p >
  <img src="docs/images/SQLiteImageBenchmark.jpg" alt="App Preview"/>
  <br/>
  <em>Интерфейс тестирования производительности</em>
</p>

[![API](https://img.shields.io/badge/API-21%2B-brightgreen.svg?style=flat)](https://android-arsenal.com/api?level=21)
[![Kotlin](https://img.shields.io/badge/kotlin-1.8.0-blue.svg?logo=kotlin)](http://kotlinlang.org)
[![License](https://img.shields.io/badge/License-Apache%202.0-blue.svg)](https://opensource.org/licenses/Apache-2.0)

Этот проект исследует различия в производительности при загрузке изображений с помощью Glide из хранилища BLOB в SQLite по сравнению с файловой системой Android. В исследовании рассматриваются различные методы оптимизации и их влияние на время загрузки в одиночном и параллельном режимах.

## Основные возможности

* Сравнение различных стратегий загрузки изображений (Файловая система, SQLite BLOB, Direct Buffer, Okio)
* Бенчмарки производительности при одиночной и параллельной загрузке
* Подробные метрики и анализ производительности
* Отслеживание выделения памяти
* Экспорт результатов в CSV для дальнейшего анализа

## Структура проекта

```
├── app/                            # Основной модуль приложения
│   └── src/
│       └── main/
│           ├── AndroidManifest.xml
│           └── java/
│               └── com/ndev/sqliteimagebenchmark/
│                   ├── GlideAppModule.kt          # Конфигурация Glide
│                   └── MainActivity.kt            # UI и запуск тестов
├── benchmark/                      # Модуль бенчмарков
│   └── src/
│       └── androidTest/
│           └── java/
│               └── com/ndev/benchmark/
│                   ├── GlidePerformanceBenchmark.kt   # Тесты производительности
│                   └── helper/
│                       └── TestAssetsHelper.kt        # Утилиты для тестов
└── benchmarkablelib/              # Библиотечный модуль
    └── src/
        └── main/
            └── java/
                └── com/ndev/benchmarkablelib/
                    ├── db/                    # Слой базы данных
                    │   └── Entities.kt        # Сущности и DAO Room
                    ├── glide/                 # Интеграция Glide
                    │   ├── BlobDataLoader.kt          # Загрузчик BLOB
                    │   ├── BlobDataLoaderOkio.kt      # Загрузчик на базе Okio
                    │   ├── ByteBufferBackedInputStream.kt
                    │   └── SqlImageDataLoader.kt      # Оптимизированный загрузчик SQL
                    ├── model/                 # Модели данных
                    │   ├── BlobData.kt
                    │   ├── PerfModels.kt      # Модели измерений производительности
                    │   └── SqlImageData.kt
                    ├── performance/           # Тестирование производительности
                    │   └── GlidePerformanceTester.kt
                    └── repository/            # Доступ к данным
                        └── ImageRepository.kt
```

### Основные компоненты:

1. **Ядро (`benchmarkablelib`)**:

   * Полная инфраструктура загрузки изображений
   * Реализация различных стратегий оптимизации
   * Утилиты измерения производительности

2. **Модуль бенчмарков (`benchmark`)**:

   * Автоматические тесты производительности
   * Стандартизированные процедуры измерения
   * Сравнение различных методов загрузки

3. **Демо-приложение (`app`)**:

   * Интерактивный интерфейс тестирования
   * Визуализация производительности в реальном времени
   * Возможность экспорта результатов

## Как проводится тестирование

1. **Подготовка данных**:

   * Загрузка тестовых изображений из ресурсов приложения
   * Сохранение каждого изображения в SQLite как BLOB
   * Параллельное сохранение тех же изображений на диск

2. **Процесс тестирования**:

   * Сначала проводится тест загрузки с диска
   * Затем проводится тест загрузки из BLOB
   * Для каждого источника выполняется заданное количество итераций
   * Время загрузки измеряется для каждого изображения

3. **Анализ результатов**:

   * Расчет и отображение статистических данных (среднее, медиана, минимум/максимум, стандартное отклонение)
   * Сравнение производительности различных методов
   * Возможность экспорта данных в CSV для дальнейшего анализа

## Инструкция по использованию:

1. Запустите приложение
2. Нажмите "Load Test Data" для подготовки изображений
3. Укажите желаемое количество итераций (по умолчанию — 10)
4. Нажмите "Run Tests" для запуска тестов
5. Просмотрите результаты на экране
6. При необходимости экспортируйте данные в CSV-файл для анализа

Для запуска автоматических бенчмарков выполните:

```bash
./gradlew :benchmark:connectedReleaseAndroidTest
```

## Технические требования

* Android 8.1 (API 27) или выше
* Kotlin 2.1.10 или выше
* Glide 4.15.1
* Room 2.7.1
* Coroutines 1.10.1

## Примечания к тестированию:

* При тестировании загрузка каждого изображения производится с отключённым кэшем памяти (skipMemoryCache)
* Перед тестами кэш Glide очищается для повышения точности
* Для уменьшения влияния случайных факторов каждый тест проводится многократно

## Модификация:

Чтобы добавить свои изображения для теста:

1. Добавьте их в папку `/res/drawable/`

## Исходные изображения

Изображения взяты из [набора данных Oxford-IIIT Pet](https://www.robots.ox.ac.uk/~vgg/data/pets/)
(лицензия: Creative Commons Attribution-ShareAlike 4.0 International) и были
преобразованы в формат webp и масштабированы (в 0.2, 0.5, 1, 2.0, 4.0 раза)
